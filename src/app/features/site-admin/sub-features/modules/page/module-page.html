<!-- Loading + error -->
<app-loading-spinner [show]="isLoading()" [diameter]="48"></app-loading-spinner>
<app-error-banner [message]="error()"></app-error-banner>

@if (!isLoading() && !error()) {
<app-card>
  <h1 class="heading-page">Modules</h1>

  <div class="relative overflow-hidden rounded-lg module-table border border-gray-light">
    <table mat-table [dataSource]="dataSource" class="w-full bg-white">
      <caption class="sr-only">
        List of modules
      </caption>

      <!-- Actions -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef class="tracking-wider">Actions</th>
        <td mat-cell *matCellDef="let module" class="flex items-center whitespace-nowrap gap-1">
          <button
            type="button"
            class="mr-2 cursor-move drag-handle"
            aria-label="Reorder module"
           
            matTooltipPosition="above"
             matTooltip="Drag to Reorder"
            mat-icon-button 
         >
            <lucide-angular [img]="icons.drag" class="text-gray-subtleAlt"></lucide-angular>
          </button>

          @if (editingModuleId() !== module.id) {
          <button
            (click)="editModule(module)"
            mat-icon-button
            class="edit-icon"
            aria-label="Edit module"
            matTooltip="Edit"
            matTooltipPosition="below"
          >
            <lucide-angular
              [img]="icons.edit"
              class="edit-icon text-gray-subtleAlt"
              aria-hidden="true"
            ></lucide-angular>
          </button>
          } @else {

          <span matTooltip="Edit fields to save" matTooltipPosition="above">
            <button
              type="button"
              (click)="saveModule(module)"
              mat-icon-button
              color="primary"
              [disabled]="!isDirty()"
              aria-label="Save module"
              matTooltip="Save"
              matTooltipPosition="below"
            >
              <lucide-angular
                [img]="icons.check"
                class="text-success"
                aria-hidden="true"
              ></lucide-angular>
            </button>
          </span>
          <button
            type="button"
            (click)="cancelEditModule()"
            mat-icon-button
            color="warn"
            aria-label="Cancel edit"
            matTooltip="Cancel"
            matTooltipPosition="below"
          >
            <lucide-angular
              [img]="icons.close"
              class="text-danger-bright"
              aria-hidden="true"
            ></lucide-angular>
          </button>
          }
        </td>
      </ng-container>

      <!-- Status -->
      <ng-container matColumnDef="status">
        <th
          mat-header-cell
          *matHeaderCellDef
          class="text-sm font-bold tracking-wider text-left text-gray-700"
        >
          Status
        </th>
        <td mat-cell *matCellDef="let module" class="p-4 whitespace-nowrap">
          <app-toggle-switch
            (stateChange)="toggleModuleStatus(module, $event)"
            [isChecked]="module.status"
            aria-label="Toggle module status"
          ></app-toggle-switch>
        </td>
      </ng-container>

      <!-- Module Name -->
      <ng-container matColumnDef="moduleName">
        <th
          mat-header-cell
          *matHeaderCellDef
          class="p-4 text-sm font-bold tracking-wider text-left text-gray-700"
        >
          Module Name
        </th>
        <td
          mat-cell
          *matCellDef="let module"
          class="p-4 whitespace-nowrap font-[Mulish] text-[14px] leading-[100%]"
        >
          @if (editingModuleId() !== module.id) {
          {{ module.moduleName }}
          } @else {
          <input
            class="edit-input"
            matInput
            [ngModel]="editedModuleName()"
            (ngModelChange)="editedModuleName.set($event); onFieldChange()"
            placeholder="Module name"
            aria-label="Module name"
          />
          }
        </td>
      </ng-container>

      <!-- Description -->
      <ng-container matColumnDef="description">
        <th
          mat-header-cell
          *matHeaderCellDef
          class="p-4 text-sm font-bold tracking-wider text-left text-gray-700"
        >
          Description
        </th>
        <td mat-cell *matCellDef="let module" class="p-4">
          @if (editingModuleId() !== module.id) {
          {{ module.description }}
          } @else {
          <input
            class="edit-input"
            matInput
            [ngModel]="editedModuleDescription()"
            (ngModelChange)="editedModuleDescription.set($event); onFieldChange()"
            placeholder="Description"
            aria-label="Description"
          />
          }
        </td>
      </ng-container>

      <!-- Icon -->
      <ng-container matColumnDef="icon">
        <th
          mat-header-cell
          *matHeaderCellDef
          class="p-4 text-sm font-bold tracking-wider text-left text-gray-700"
        >
          Icon
        </th>
        <td mat-cell *matCellDef="let module" class="p-4 whitespace-nowrap">
          <mat-icon class="module-icon" aria-hidden="true">{{ module.icon }}</mat-icon>
        </td>
      </ng-container>

      <!-- Header/Data rows -->
      <tr mat-header-row *matHeaderRowDef="displayedColumns" class="bg-gray-50"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

      <!-- Empty state -->
      <tr class="mat-row" *ngIf="(dataSource.data?.length ?? 0) === 0">
        <td class="mat-cell p-6 text-center text-gray-500" [attr.colspan]="displayedColumns.length">
          No modules found.
        </td>
      </tr>
    </table>

    <!--  paginator -->
    <mat-paginator
      [pageSize]="6"
      [pageSizeOptions]="[5, 10, 25, 50, 100]"
      showFirstLastButtons
      aria-label="Modules pagination"
    ></mat-paginator>
  </div>
</app-card>
}
